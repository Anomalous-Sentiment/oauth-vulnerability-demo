<?php
header('Access-Control-Allow-Origin: *');
header("Access-Control-Allow-Credentials: true");
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
header("Access-Control-Allow-Headers: X-Requested-With, Content-Type, Origin, Cache-Control, Pragma, Authorization, Accept, Accept-Encoding");
header("Access-Control-Max-Age: 600");

require_once "../config.php";
header('Content-Type: application/json');

$username = "";

if(isset($_GET['oauth_consumer_key']))
{
    if(isset($_GET['oauth_token']))
    {
        if(isset($_GET['oauth_verifier']))
        {
            $consumer_key = $_GET['oauth_consumer_key'];
            $token = $_GET['oauth_token'];
            $verifier = $_GET['oauth_verifier'];
            

            // SELECT statement for authenticated users to the OAUTH app
            $sql = "SELECT authlist.username
                    FROM authlist, apps 
                    WHERE authlist.oauth_verifier = ?
                    AND authlist.oauth_token = ? 
                    AND apps.oauth_consumer_key = ?";
                
            if($stmt = mysqli_prepare($link, $sql))
            {
                // Binds $p_consumer_key, $p_oauth_token and $p_oauth_verifier parameter to SELECT statement
                mysqli_stmt_bind_param($stmt, "sss", $p_oauth_verifier, $p_oauth_token, $p_consumer_key);
                
                // Set paramater to consumer_key and token given
                $p_oauth_verifier = trim($verifier);
                $p_oauth_token = trim($token);
                $p_consumer_key = trim($consumer_key);
                
                // Execute sql SELECT statement
                if(mysqli_stmt_execute($stmt))
                {
                    // Save the result
                    mysqli_stmt_store_result($stmt);
                    
                    if(mysqli_stmt_num_rows($stmt) == 0)
                    {
                        // JSON Object Reponse
                        // {"oauth_problem":"incorrect_token"}  
                        $data = [ 'oauth_problem' => 'incorrect_token'];
                        echo json_encode($data);
                        die();
                    }
                    else
                    {
                        // Successfully found authorised username to the application
                        mysqli_stmt_bind_result($stmt, $username);
                        mysqli_stmt_fetch($stmt);
                    }
                } 
                else
                {
                    echo "Something went wrong.";
                    die();
                }

                // Close statement
                mysqli_stmt_close($stmt);
            }


            // UPDATE statement for generating access token and access token secret
            $sql = "INSERT INTO accesslist VALUES(?, ?, ?)";

            if($stmt = mysqli_prepare($link, $sql))
            {
                // Bind $p_username paramater to SELECT statement
                mysqli_stmt_bind_param($stmt, "sss", $p_token, $p_access_token, $p_access_token_secret);
                
                // Random number generator for 17 digits and random 8 bytes of data into hexadecimal
                $access_token = rand(10000000000000000, 99999999999999999) . "-" . bin2hex(random_bytes(8));

                // Random 8 bytes of data into hexadecimal
                $access_token_secret = bin2hex(random_bytes(8));

                // Set the parameter to the tokens generated
                $p_token = $token;
                $p_access_token = $access_token;
                $p_access_token_secret = $access_token_secret;
                
                // Execute the UPDATE statement
                if(mysqli_stmt_execute($stmt))
                {
                    // JSON Object Reponse
                    // {"oauth_token":"42650231806795291-ef578360e11cc3c3", "oauth_token_secret":"81890bce89e006a6"}  
                    $data = [ 'username' => $username, 'oauth_token' => $access_token, 'oauth_token_secret' => $access_token_secret];
                    echo json_encode($data);
                }
            }
        }
        else
        {
            // JSON Object Reponse
            // {"oauth_problem":"oauth_verifier_unknown"}  
            $data = [ 'oauth_problem' => 'token_unknown'];
            echo json_encode($data);
        }
    }
    else
    {

        // JSON Object Reponse
        // {"oauth_problem":"oauth_token_unknown"}  
        $data = [ 'oauth_problem' => 'token_unknown'];
        echo json_encode($data);
    }
}
else
{
    // JSON Object Reponse
    // {"oauth_problem":"consumer_key_unknown"}  
    $data = [ 'oauth_problem' => 'consumer_key_unknown'];
    echo json_encode($data);
}

?>