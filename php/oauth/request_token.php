<?php
require_once "../config.php";
header('Content-Type: application/json');

if(isset($_GET['oauth_consumer_key']))
{
    $consumer_key = $_GET['oauth_consumer_key'];
    $token = $token_secret = "";

    // SELECT statement for searching the consumer key exist
    $sql = "SELECT * FROM apps WHERE oauth_consumer_key = ?";
        
    if($stmt = mysqli_prepare($link, $sql))
    {
        // Binds $p_consumer_key parameter to SELECT statement
        mysqli_stmt_bind_param($stmt, "s", $p_consumer_key);
        
        // Set paramater to consumer_key given
        $p_consumer_key = trim($consumer_key);
        
        // Execute sql SELECT statement
        if(mysqli_stmt_execute($stmt))
        {
            // Save the result
            mysqli_stmt_store_result($stmt);
            
            if(mysqli_stmt_num_rows($stmt) == 0)
            {
                // Plaintext response
                //echo 'oauth_problem=consumer_key_unknown';

                // JSON Object Reponse
                // {"oauth_problem":"consumer_key_unknown"}  
                $data = [ 'oauth_problem=' => 'consumer_key_unknown'];
                echo json_encode($data);
                die();
            } 
        } 
        else
        {
            echo "Something went wrong.";
        }

        // Close statement
        mysqli_stmt_close($stmt);
    }

    // UPDATE statement for generating authorize token and token secret
    $sql = "UPDATE apps SET oauth_token = ?, oauth_token_secret = ? WHERE oauth_consumer_key = ?";

    if($stmt = mysqli_prepare($link, $sql))
    {
        // Bind $p_username paramater to SELECT statement
        mysqli_stmt_bind_param($stmt, "sss", $p_token, $p_token_secret, $p_consumer_key);
        
        // Random number generator for 17 digits and random 8 bytes of data into hexadecimal
        $token = rand(10000000000000000, 99999999999999999) . "-" . bin2hex(random_bytes(8));

        // Random 8 bytes of data into hexadecimal
        $token_secret = bin2hex(random_bytes(8));

        // Set the parameter to the tokens generated
        $p_token = $token;
        $p_token_secret = $token_secret;
        $p_consumer_key = $consumer_key;
        
        // Execute the UPDATE statement
        if(mysqli_stmt_execute($stmt))
        {
            // Plaintext response
            //echo 'oauth_token=' . $token . '&oauth_token_secret=' . $token_secret;

            // JSON Object Reponse
            // {"oauth_token":"42650231806795291-ef578360e11cc3c3", "oauth_token_secret":"81890bce89e006a6"}  
            $data = [ 'oauth_token=' => $token, 'oauth_token_secret=' => $token_secret];
            echo json_encode($data);
        }
    }
    }
    else
    {
        // Plaintext response
        //echo 'oauth_problem=consumer_key_unknown';

        // JSON Object Reponse
        // {"oauth_problem":"consumer_key_unknown"}  
        $data = [ 'oauth_problem=' => 'consumer_key_unknown'];
        echo json_encode($data);
    }

?>