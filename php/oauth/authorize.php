<?php
require_once "../config.php";
// Initialize session
session_start();

// Current authorization URL
$url =  "//{$_SERVER['HTTP_HOST']}{$_SERVER['REQUEST_URI']}";

// Initalize values
$name = $oauth_callback = $token = "";
$appId = -1;

if($_SERVER["REQUEST_METHOD"] == "GET") 
{

    if(isset($_GET['oauth_token']))
    {
        $token = $_GET['oauth_token'];

        // SELECT statement for searching if token is correct and grabbing the oauth_callback URL
        $sql = "SELECT id, oauth_callback FROM authlist WHERE authlist.oauth_token = ?";
            
        if($stmt = mysqli_prepare($link, $sql))
        {
            // Binds $p_token parameter to SELECT statement
            mysqli_stmt_bind_param($stmt, "s", $p_token);
            
            // Set paramater to token key given in HTTP GET
            $p_token = trim($token);
            
            // Execute sql SELECT statement
            if(mysqli_stmt_execute($stmt))
            {
                // Save the result
                mysqli_stmt_store_result($stmt);
                
                if(mysqli_stmt_num_rows($stmt) == 0)
                {
                    // JSON Object Reponse
                    // {"oauth_problem":"oauth_token_unknown"}  
                    $data = [ 'oauth_problem=' => 'oauth_token_unknown'];
                    echo json_encode($data);
                    die();
                } 
                else
                {
                    mysqli_stmt_bind_result($stmt, $appId, $oauth_callback);
                    mysqli_stmt_fetch($stmt);
                }

            } 
            else
            {
                echo "Something went wrong.";
            }

            // Close statement
            mysqli_stmt_close($stmt);
        }

        // Check if the user is already logged in using session cookies
        // If found then redirect to authorization page with authorization token
        if(isset($_SESSION["loggedin"]) && $_SESSION["loggedin"] === true)
        {
            // User has just logged in or is logged in already
        }
        else
        {

            header("location: /login?redir=" . $url);
            exit;
        }
        

        // Grab the app name
        $sql = "SELECT name FROM apps WHERE id = ?"; 
        if($stmt = mysqli_prepare($link, $sql))
        {
            // Bind $p_appid to SELECT statement
            mysqli_stmt_bind_param($stmt, "d", $p_appId);

            // Set parameters
            $p_appId = $appId;
            
            // Execute sql SELECT statement
            mysqli_stmt_execute($stmt);

            mysqli_stmt_bind_result($stmt, $name);
            mysqli_stmt_fetch($stmt);

            // Close statement
            mysqli_stmt_close($stmt);
        }
        
        
        // Close connection
        mysqli_close($link);
        }
    
}


// Process form data when user clicks 'Authorize'
if($_SERVER["REQUEST_METHOD"] == "POST")
{

    $oauth_callback = $_POST["oauth_callback"];
    $oauth_token = $_POST["oauth_token"];

    // Preparing UPDATE statement to add mark the authorisation URL as used
    $sql = "UPDATE authlist SET username = ?, oauth_verifier = ? WHERE oauth_token = ?"; 
        
    if($stmt = mysqli_prepare($link, $sql))
    {
        // Bind $p_appid, $p_username to INSERT statement
        mysqli_stmt_bind_param($stmt, "sss", $p_username, $p_oauth_verifier, $p_token);

        // Random 8 bytes of data into hexadecimal
        $oauth_verifier = bin2hex(random_bytes(8));

        // Set parameters
        $p_token = trim($oauth_token);
        $p_oauth_verifier = $oauth_verifier;
        $p_username = $_SESSION["username"];
        
        // Execute sql INSERT statement
        mysqli_stmt_execute($stmt);


        // Close statement
        mysqli_stmt_close($stmt);
    }
    
    
    // Close connection
    mysqli_close($link);

    // Required Callback URL stated. 
    // Example redirection with Callback URL to
    // http://localhost:4000/oauth/callback?oauth_token=97522688124226114-5136c8319f78f4e1
    header("location: " .  $oauth_callback  . "?oauth_token=" . $oauth_token . "&oauth_verifier=" . $oauth_verifier);

    
}

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <title>OAUTH - Authorization</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script>
        function callbackURL()
        {
            window.location.replace("<?php echo $oauth_callback . "?oauth_token=" . $token?>");
        }
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/login">Home</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav mr-auto">
            <a class="nav-item nav-link" href="/dashboard/">Dashboard<span class="sr-only"></span></a>
            <a class="nav-item nav-link active" href="/dashboard/create">Create App<span class="sr-only">(current)</span></a>
            </div>
            <div class="nav navbar-nav">
            <a class="nav-item nav-link" href="/dashboard/logout">Log out</a>
            </div>
        </div>
    </nav>
    <div class="container main-window">
        <div class="row" style="text-align: center">
            <h4>Hi <?php echo $_SESSION["username"]; ?></h2>
            <br>
            <div class="alert alert-danger">
                <h5><?php echo $name; ?> wants to link to your account.</h5>
                <br>
                <p style="color:red">This is a third-party service. If you don't trust it with access to your account, then you should not authorize it.</p>
            </div>

            <p>By authorizing this link, you'll allow <?php echo $name; ?> to:</p>
            <ul id="allow-list">
                <li>✔️<b>Access</b> your account</li>
                <li>✔️<b>View</b> photos in your library</li>
                <li>✔️<b>View</b> your personal details</li>
            </ul>

            <form action="" method="post" id="form">
                <div class="form-group">
                    <input type="hidden" name="oauth_callback" value="<?php echo $oauth_callback ?>">
                    <input type="hidden" name="oauth_token" value="<?php echo $token ?>">
                    <input type="submit" class="btn btn-primary" value="Authorize">
                </div>
            </form>
            <form action="../dashboard" id="cancel">
                <div class="form-group">
                    <input type="submit" class="btn btn-secondary" value="Cancel">
                </div>
            </form>
        </div>
    </div>
</body>
</html>


