<?php
// Include config file
require_once "../config.php";

// Initialize session
session_start();
 
// Check if the user is logged in using session cookies, 
// If not redirect back to login
if(!isset($_SESSION["loggedin"]) || $_SESSION["loggedin"] !== true){
    header("location: login");
    exit;
}
 
// Initialize values
$name = "";
$name_error = "";
$username = $_SESSION["username"];
$match = 0;
 
// Process form data when submitted
if($_SERVER["REQUEST_METHOD"] == "POST")
{
    
    // App name must not be empty
    if(empty(trim($_POST["name"])))
    {
        $name_error = "App name must not be empty!";     
    } 
    else
    {
        $name = trim($_POST["name"]);
    }
    
    do
    {
        //Creates 32 bytes of random data and converts it to hexadecimal for consumer_key
        $random_hex = bin2hex(random_bytes(16));

        // SELECT statement for ensuring theres no duplicate consumer_key
        $sql = "SELECT oauth_consumer_key FROM apps WHERE oauth_consumer_key = ?";
        
        if($stmt = mysqli_prepare($link, $sql))
        {
            // Bind $p_consumer_key paramater to SELECT statement
            mysqli_stmt_bind_param($stmt, "s", $p_consumer_key);
            
            // Set the parameter to the random hex generated
            $p_consumer_key = $random_hex;
            
            // Execute the SELECT statement
            if(mysqli_stmt_execute($stmt))
            {
                // Save result
                mysqli_stmt_store_result($stmt);
                
                // If consumer key does exists already, generate another
                if(mysqli_stmt_num_rows($stmt) != 0)
                {                    
                    $match = 1;
                }
            }
            mysqli_stmt_close($stmt);
        } 
    } while($match != 0);


    // Preparing INSERT statement
    $sql = "INSERT INTO apps (name, username, oauth_consumer_key) VALUES (?, ?, ?)";
        
    if($stmt = mysqli_prepare($link, $sql))
    {
        // Bind $p_name, $p_username and $p_consumer_key parameters to INSERT statement
        mysqli_stmt_bind_param($stmt, "sss", $p_name, $p_username, $p_consumer_key);

        // Set parameters
        $p_name = $name;
        $p_username = $username;
        $p_consumer_key = $random_hex;
        
        // Execute sql INSERT statement
        if(mysqli_stmt_execute($stmt))
        {
            // Rediret to dashboard page if successfull
            header("location: /dashboard/");
        } else
        {
            echo "Something went wrong.";
        }

        // Close statement
        mysqli_stmt_close($stmt);
    }
    
    
    // Close connection
    mysqli_close($link);
}
?>
 
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Welcome</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <style>
        body { font: 14px sans-serif; text-align: center; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/login">Home</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav mr-auto">
            <a class="nav-item nav-link" href="/dashboard/">Dashboard<span class="sr-only"></span></a>
            <a class="nav-item nav-link active" href="/dashboard/create">Create App<span class="sr-only">(current)</span></a>
            </div>
            <div class="nav navbar-nav">
            <a class="nav-item nav-link" href="logout">Log out</a>
            </div>
        </div>
    </nav>
    <div class="container main-window">
        <div class="row">
            <h4>Create an OAUTH Application</h2>
            <br>

            <form action="" method="post" id="form">
                <div class="form-group" style="text-align: left";>
                    <label>Name of the app</label>
                    <input type="text" name="name" class="form-control <?php echo (!empty($name_error)) ? 'is-invalid' : ''; ?>" value="<?php echo $name; ?>">
                    <span class="invalid-feedback"><?php echo $name_error; ?></span>
                </div>    
                <div class="form-group" style="text-align: left";>
                    <input type="checkbox" name="terms" required>  I Agree to the API Terms & Coditions
                </div>
                <div class="form-group">
                    <input type="submit" class="btn btn-primary" value="Submit" id="submit">
                </div>
            </form>
        </div>
    </div>
</body>
</html>