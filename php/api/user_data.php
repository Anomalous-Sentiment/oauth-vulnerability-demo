<?php
header('Access-Control-Allow-Origin: *');
header("Access-Control-Allow-Credentials: true");
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
header("Access-Control-Allow-Headers: X-Requested-With, Content-Type, Origin, Cache-Control, Pragma, Authorization, Accept, Accept-Encoding");
header("Access-Control-Max-Age: 600");

require_once "../config.php";
header('Content-Type: application/json');

$username = "";

if(isset($_GET['oauth_consumer_key']))
{
    if(isset($_GET['oauth_token']))
    {
        $consumer_key = $_GET['oauth_consumer_key'];
        $oauth_access_token = $_GET['oauth_token'];

        // SELECT statement getting user data with access token and consumer key
        $sql = "SELECT accounts.username FROM accounts, authlist, accesslist, apps
                WHERE accesslist.oauth_access_token = ?
                AND authlist.username = accounts.username
                AND apps.oauth_consumer_key = ?";
            
        if($stmt = mysqli_prepare($link, $sql))
        {
            // Binds $p_consumer_key and $p_oauth_token parameter to SELECT statement
            mysqli_stmt_bind_param($stmt, "ss", $p_oauth_access_token, $p_consumer_key);
            
            // Set paramater to consumer_key and token given
            $p_oauth_access_token = trim($oauth_access_token);
            $p_consumer_key = trim($consumer_key);
            
            // Execute sql SELECT statement
            if(mysqli_stmt_execute($stmt))
            {
                // Save the result
                mysqli_stmt_store_result($stmt);
                
                if(mysqli_stmt_num_rows($stmt) == 0)
                {
                    // JSON Object Reponse
                    // {"oauth_problem":"unknown_entry"}  
                    $data = [ 'oauth_problem' => 'unknown_entry'];
                    echo json_encode($data);
                    die();
                }
                else
                {
                    // Successfully found authorised username with access token
                    mysqli_stmt_bind_result($stmt, $username);
                    mysqli_stmt_fetch($stmt);
                    
                    $data = [ 'username' => $username, 'stat' => 'ok'];
                    echo json_encode($data);
                }
            } 
            else
            {
                echo "Something went wrong.";
                die();
            }

            // Close statement
            mysqli_stmt_close($stmt);
        }
    }
    else
    {

        // JSON Object Reponse
        // {"oauth_problem":"oauth_token_unknown"}  
        $data = [ 'oauth_problem' => 'token_unknown'];
        echo json_encode($data);
    }
}
else
{
    // JSON Object Reponse
    // {"oauth_problem":"consumer_key_unknown"}  
    $data = [ 'oauth_problem' => 'consumer_key_unknown'];
    echo json_encode($data);
}

?>