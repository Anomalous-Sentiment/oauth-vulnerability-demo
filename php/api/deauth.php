<?php
header('Access-Control-Allow-Origin: *');
header("Access-Control-Allow-Credentials: true");
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
header("Access-Control-Allow-Headers: X-Requested-With, Content-Type, Origin, Cache-Control, Pragma, Authorization, Accept, Accept-Encoding");
header("Access-Control-Max-Age: 600");

require_once "../config.php";
header('Content-Type: application/json');

$username = $oauth_token = "";

if(isset($_GET['oauth_consumer_key']))
{
    if(isset($_GET['oauth_token']))
    {
        $consumer_key = $_GET['oauth_consumer_key'];
        $oauth_access_token = $_GET['oauth_token'];

        // SELECT statement getting auth token using the access token
        $sql = "SELECT oauth_token
                FROM accesslist
                WHERE oauth_access_token = ?";
            
        if($stmt = mysqli_prepare($link, $sql))
        {
            // Binds $p_oauth_access_token parameter to SELECT statement
            mysqli_stmt_bind_param($stmt, "s", $p_oauth_access_token);
            
            // Set paramater to the token given
            $p_oauth_access_token = trim($oauth_access_token);

            // Execute sql SELECT statement
            if(mysqli_stmt_execute($stmt))
            {
                // Save the result
                mysqli_stmt_store_result($stmt);
                
                if(mysqli_stmt_num_rows($stmt) == 0)
                {
                    // JSON Object Reponse
                    // {"oauth_problem":"unknown_entry"}  
                    $data = [ 'oauth_problem' => 'unknown_entry'];
                    echo json_encode($data);
                    die();
                }
                else
                {
                    // Successfully found auth token with access token
                    mysqli_stmt_bind_result($stmt, $oauth_token);
                    mysqli_stmt_fetch($stmt);
                }
            } 
            else
            {
                echo "Something went wrong.";
                die();
            }

            // Close statement
            mysqli_stmt_close($stmt);
        }


        
        // DELETE statement removing access record from accesslist table
        $sql = "DELETE FROM accesslist
                WHERE oauth_access_token = ?";

        if($stmt = mysqli_prepare($link, $sql))
        {
            // Binds and $p_oauth_access_token parameter to DELETE statement
            mysqli_stmt_bind_param($stmt, "s", $p_oauth_access_token);
            
            // Set paramater to the token given
            $p_oauth_access_token = trim($oauth_access_token);

            // Execute sql DELETE statement
            if(!mysqli_stmt_execute($stmt))
            {
                echo "Something went wrong.";
                die();
            }

            // Close statement
            mysqli_stmt_close($stmt);
        }


        // DELETE statement removing auth record from authlist table
        $sql = "DELETE FROM authlist
                WHERE oauth_token = ?";

        if($stmt = mysqli_prepare($link, $sql))
        {
            // Binds and $p_oauth_token parameter to DELETE statement
            mysqli_stmt_bind_param($stmt, "s", $p_oauth_token);
            
            // Set paramater to the token given
            $p_oauth_token = trim($oauth_token);

            // Execute sql DELETE statement
            if(mysqli_stmt_execute($stmt))
            {
                // JSON Object Reponse
                // {"stat":"ok"}  
                $data = [ 'stat' => 'ok'];
                echo json_encode($data);
                die();
            }
            else
            {
                echo "Something went wrong.";
                die();
            }

            // Close statement
            mysqli_stmt_close($stmt);
        }
    }
    else
    {

        // JSON Object Reponse
        // {"oauth_problem":"oauth_token_unknown"}  
        $data = [ 'oauth_problem' => 'token_unknown'];
        echo json_encode($data);
    }
}
else
{
    // JSON Object Reponse
    // {"oauth_problem":"consumer_key_unknown"}  
    $data = [ 'oauth_problem' => 'consumer_key_unknown'];
    echo json_encode($data);
}

?>